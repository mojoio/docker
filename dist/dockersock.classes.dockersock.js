"use strict";
require("typings-global");
var plugins = require("./dockersock.plugins");
var Dockersock = (function () {
    function Dockersock(pathArg) {
        if (pathArg === void 0) { pathArg = "http://unix:/var/run/docker.sock:"; }
        this.sockPath = pathArg;
    }
    // methods
    Dockersock.prototype.auth = function (userArg, passArg) {
        var done = plugins.q.defer();
        this.request("POST", "");
        return done.promise;
    };
    Dockersock.prototype.listContainers = function () {
        var done = plugins.q.defer();
        this.request("GET", "/containers")
            .then(done.resolve);
        return done.promise;
    };
    ;
    Dockersock.prototype.listContainersDetailed = function () {
        var _this = this;
        var done = plugins.q.defer();
        var detailedDataObject = [];
        this.listContainers()
            .then(function (dataArg) {
            var recursiveCounter = 0;
            var makeDetailed = function () {
                if (typeof dataArg[recursiveCounter] != "undefined") {
                    _this.request("GET", "/containers/" + dataArg[recursiveCounter].Id)
                        .then(function (dataArg2) {
                        detailedDataObject.push(dataArg2);
                        recursiveCounter++;
                        // recursive call
                        makeDetailed();
                    });
                }
                else {
                    done.resolve(detailedDataObject);
                }
            };
            makeDetailed();
        });
        return done.promise;
    };
    ;
    Dockersock.prototype.listContainersRunning = function () {
        var done = plugins.q.defer();
        return done.promise;
    };
    Dockersock.prototype.listContainersStopped = function () {
        var done = plugins.q.defer();
        return done.promise;
    };
    Dockersock.prototype.listImages = function () {
        return this.request("GET", "/images", "?all=true");
    };
    Dockersock.prototype.listImagesDangling = function () {
        return this.request("GET", "/images", "?dangling=true");
    };
    Dockersock.prototype.pullImage = function (imageLabel) {
        return this.requestStream("POST", "/images/create?fromImage=" + imageLabel);
    };
    ;
    Dockersock.prototype.createContainer = function (imageNameArg, pullFirst) {
        if (pullFirst === void 0) { pullFirst = true; }
        return this.request("POST", "/containers/create", "", {
            "image": imageNameArg
        });
    };
    ;
    Dockersock.prototype.getContainerId = function () {
    };
    ;
    Dockersock.prototype.startContainer = function (containerNameArg) {
        return this.request("POST", "/containers/" + containerNameArg + "/start");
    };
    ;
    Dockersock.prototype.stopContainer = function (containerNameArg) {
        return this.request("POST", "/containers/" + containerNameArg + "/stop");
    };
    ;
    Dockersock.prototype.removeContainer = function (containerNameArg) {
        return this.request("DELETE", "/containers/" + containerNameArg + "?v=1");
    };
    ;
    Dockersock.prototype.clean = function () {
        var done = plugins.q.defer();
        return done.promise;
    };
    ;
    Dockersock.prototype.getChange = function () {
    };
    ;
    Dockersock.prototype.request = function (methodArg, routeArg, queryArg, dataArg) {
        if (queryArg === void 0) { queryArg = ""; }
        if (dataArg === void 0) { dataArg = {}; }
        var done = plugins.q.defer();
        var jsonArg = JSON.stringify(dataArg);
        var suffix = "";
        if (methodArg == "GET")
            suffix = "/json";
        var options = {
            method: methodArg,
            url: this.sockPath + routeArg + suffix + queryArg,
            headers: {
                "Content-Type": "application/json"
            },
            body: jsonArg
        };
        plugins.request(options, function (err, res, body) {
            if (!err && res.statusCode == 200) {
                var responseObj = JSON.parse(body);
                done.resolve(responseObj);
            }
            else {
                console.log(err);
                console.log(res);
                done.reject(err);
            }
            ;
        });
        return done.promise;
    };
    Dockersock.prototype.requestStream = function (methodArg, routeArg, endArg) {
        if (endArg === void 0) { endArg = true; }
        var done = plugins.q.defer();
        if (methodArg == "POST") {
            var requestStream = plugins.request.post(this.sockPath + routeArg);
            requestStream.on("response", function (response) {
                if (response.statusCode == 200) {
                    plugins.beautylog.ok("request returned status 200, so we are good!");
                }
                else {
                    plugins.beautylog.error("request returned error: " + response.statusCode);
                    done.reject();
                }
            });
            requestStream.on("data", function (data) {
                var status = JSON.parse(data.toString()).status;
                plugins.beautylog.log(status);
            });
            requestStream.on("end", function () {
                done.resolve();
            });
        }
        return done.promise;
    };
    return Dockersock;
}());
exports.Dockersock = Dockersock;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRvY2tlcnNvY2suY2xhc3Nlcy5kb2NrZXJzb2NrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxRQUFPLGdCQUNQLENBQUMsQ0FEc0I7QUFDdkIsSUFBWSxPQUFPLFdBQU0sc0JBQXNCLENBQUMsQ0FBQTtBQUVoRDtJQUVJLG9CQUFZLE9BQW9EO1FBQXBELHVCQUFvRCxHQUFwRCw2Q0FBb0Q7UUFDNUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7SUFDNUIsQ0FBQztJQUVELFVBQVU7SUFDVix5QkFBSSxHQUFKLFVBQUssT0FBYyxFQUFDLE9BQWM7UUFDOUIsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBQyxFQUFFLENBQUMsQ0FBQztRQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN4QixDQUFDO0lBQ0QsbUNBQWMsR0FBZDtRQUNJLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUMsYUFBYSxDQUFDO2FBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDeEIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDeEIsQ0FBQzs7SUFDRCwyQ0FBc0IsR0FBdEI7UUFBQSxpQkFzQkM7UUFyQkcsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM3QixJQUFJLGtCQUFrQixHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsY0FBYyxFQUFFO2FBQ2hCLElBQUksQ0FBQyxVQUFDLE9BQU87WUFDVixJQUFJLGdCQUFnQixHQUFHLENBQUMsQ0FBQztZQUN6QixJQUFJLFlBQVksR0FBRztnQkFDZixFQUFFLENBQUEsQ0FBQyxPQUFP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Q0FBQztRQUNQLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN4QixDQUFDO0lBQ0wsaUJBQUM7QUFBRCxDQWpJQSxBQWlJQyxJQUFBO0FBaklZLGtCQUFVLGFBaUl0QixDQUFBIiwiZmlsZSI6ImRvY2tlcnNvY2suY2xhc3Nlcy5kb2NrZXJzb2NrLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFwidHlwaW5ncy1nbG9iYWxcIlxuaW1wb3J0ICogYXMgcGx1Z2lucyBmcm9tIFwiLi9kb2NrZXJzb2NrLnBsdWdpbnNcIjtcblxuZXhwb3J0IGNsYXNzIERvY2tlcnNvY2sge1xuICAgIHNvY2tQYXRoOnN0cmluZztcbiAgICBjb25zdHJ1Y3RvcihwYXRoQXJnOnN0cmluZyA9IFwiaHR0cDovL3VuaXg6L3Zhci9ydW4vZG9ja2VyLnNvY2s6XCIpe1xuICAgICAgICB0aGlzLnNvY2tQYXRoID0gcGF0aEFyZztcbiAgICB9XG5cbiAgICAvLyBtZXRob2RzXG4gICAgYXV0aCh1c2VyQXJnOnN0cmluZyxwYXNzQXJnOnN0cmluZyl7XG4gICAgICAgIGxldCBkb25lID0gcGx1Z2lucy5xLmRlZmVyKCk7XG4gICAgICAgIHRoaXMucmVxdWVzdChcIlBPU1RcIixcIlwiKTtcbiAgICAgICAgcmV0dXJuIGRvbmUucHJvbWlzZTtcbiAgICB9XG4gICAgbGlzdENvbnRhaW5lcnMoKSB7XG4gICAgICAgIGxldCBkb25lID0gcGx1Z2lucy5xLmRlZmVyKCk7XG4gICAgICAgIHRoaXMucmVxdWVzdChcIkdFVFwiLFwiL2NvbnRhaW5lcnNcIilcbiAgICAgICAgICAgIC50aGVuKGRvbmUucmVzb2x2ZSk7XG4gICAgICAgIHJldHVybiBkb25lLnByb21pc2U7XG4gICAgfTtcbiAgICBsaXN0Q29udGFpbmVyc0RldGFpbGVkKCkge1xuICAgICAgICBsZXQgZG9uZSA9IHBsdWdpbnMucS5kZWZlcigpO1xuICAgICAgICBsZXQgZGV0YWlsZWREYXRhT2JqZWN0ID0gW107XG4gICAgICAgIHRoaXMubGlzdENvbnRhaW5lcnMoKVxuICAgICAgICAgICAgLnRoZW4oKGRhdGFBcmcpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcmVjdXJzaXZlQ291bnRlciA9IDA7XG4gICAgICAgICAgICAgICAgbGV0IG1ha2VEZXRhaWxlZCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIGRhdGFBcmdbcmVjdXJzaXZlQ291bnRlcl0gIT0gXCJ1bmRlZmluZWRcIil7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlcXVlc3QoXCJHRVRcIixcIi9jb250YWluZXJzL1wiICsgZGF0YUFyZ1tyZWN1cnNpdmVDb3VudGVyXS5JZClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoZGF0YUFyZzIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlsZWREYXRhT2JqZWN0LnB1c2goZGF0YUFyZzIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVDb3VudGVyKys7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlY3Vyc2l2ZSBjYWxsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ha2VEZXRhaWxlZCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZS5yZXNvbHZlKGRldGFpbGVkRGF0YU9iamVjdCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIG1ha2VEZXRhaWxlZCgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBkb25lLnByb21pc2U7XG4gICAgfTtcbiAgICBsaXN0Q29udGFpbmVyc1J1bm5pbmcoKSB7XG4gICAgICAgIGxldCBkb25lID0gcGx1Z2lucy5xLmRlZmVyKCk7XG4gICAgICAgIHJldHVybiBkb25lLnByb21pc2U7XG4gICAgfVxuICAgIGxpc3RDb250YWluZXJzU3RvcHBlZCgpIHtcbiAgICAgICAgbGV0IGRvbmUgPSBwbHVnaW5zLnEuZGVmZXIoKTtcbiAgICAgICAgcmV0dXJuIGRvbmUucHJvbWlzZTtcbiAgICB9XG4gICAgbGlzdEltYWdlcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdChcIkdFVFwiLFwiL2ltYWdlc1wiLFwiP2FsbD10cnVlXCIpO1xuICAgIH1cbiAgICBsaXN0SW1hZ2VzRGFuZ2xpbmcoKXtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdChcIkdFVFwiLFwiL2ltYWdlc1wiLFwiP2RhbmdsaW5nPXRydWVcIik7XG4gICAgfVxuICAgIHB1bGxJbWFnZShpbWFnZUxhYmVsOnN0cmluZyl7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3RTdHJlYW0oXCJQT1NUXCIsXCIvaW1hZ2VzL2NyZWF0ZT9mcm9tSW1hZ2U9XCIgKyBpbWFnZUxhYmVsKTtcbiAgICB9O1xuICAgIGNyZWF0ZUNvbnRhaW5lcihpbWFnZU5hbWVBcmcscHVsbEZpcnN0OmJvb2xlYW4gPSB0cnVlKXtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdChcIlBPU1RcIixcIi9jb250YWluZXJzL2NyZWF0ZVwiLFwiXCIse1xuICAgICAgICAgICAgXCJpbWFnZVwiOmltYWdlTmFtZUFyZ1xuICAgICAgICB9KTtcbiAgICB9O1xuICAgIGdldENvbnRhaW5lcklkKCl7XG5cbiAgICB9O1xuICAgIHN0YXJ0Q29udGFpbmVyKGNvbnRhaW5lck5hbWVBcmcpe1xuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KFwiUE9TVFwiLFwiL2NvbnRhaW5lcnMvXCIrIGNvbnRhaW5lck5hbWVBcmcgK1wiL3N0YXJ0XCIpO1xuICAgIH07XG4gICAgc3RvcENvbnRhaW5lcihjb250YWluZXJOYW1lQXJnKXtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdChcIlBPU1RcIixcIi9jb250YWluZXJzL1wiKyBjb250YWluZXJOYW1lQXJnICtcIi9zdG9wXCIpO1xuICAgIH07XG4gICAgcmVtb3ZlQ29udGFpbmVyKGNvbnRhaW5lck5hbWVBcmcpe1xuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KFwiREVMRVRFXCIsXCIvY29udGFpbmVycy9cIiArIGNvbnRhaW5lck5hbWVBcmcgKyBcIj92PTFcIik7XG4gICAgfTtcbiAgICBjbGVhbigpIHtcbiAgICAgICAgbGV0IGRvbmUgPSBwbHVnaW5zLnEuZGVmZXIoKTtcbiAgICAgICAgcmV0dXJuIGRvbmUucHJvbWlzZTtcbiAgICB9O1xuICAgIGdldENoYW5nZSgpe1xuXG4gICAgfTtcbiAgICByZXF1ZXN0KG1ldGhvZEFyZzpzdHJpbmcscm91dGVBcmc6c3RyaW5nLHF1ZXJ5QXJnOnN0cmluZyA9IFwiXCIsIGRhdGFBcmcgPSB7fSl7XG4gICAgICAgIGxldCBkb25lID0gcGx1Z2lucy5xLmRlZmVyKCk7XG4gICAgICAgIGxldCBqc29uQXJnOnN0cmluZyA9IEpTT04uc3RyaW5naWZ5KGRhdGFBcmcpO1xuICAgICAgICBsZXQgc3VmZml4OnN0cmluZyA9IFwiXCI7XG4gICAgICAgIGlmKG1ldGhvZEFyZyA9PSBcIkdFVFwiKSBzdWZmaXggPSBcIi9qc29uXCI7XG4gICAgICAgIGxldCBvcHRpb25zID0ge1xuICAgICAgICAgICAgbWV0aG9kOm1ldGhvZEFyZyxcbiAgICAgICAgICAgIHVybDp0aGlzLnNvY2tQYXRoICsgcm91dGVBcmcgKyBzdWZmaXggKyBxdWVyeUFyZyxcbiAgICAgICAgICAgIGhlYWRlcnM6e1xuICAgICAgICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6XCJhcHBsaWNhdGlvbi9qc29uXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBib2R5Ompzb25BcmdcbiAgICAgICAgfTtcbiAgICAgICAgcGx1Z2lucy5yZXF1ZXN0KG9wdGlvbnMsKGVyciwgcmVzLCBib2R5KSA9PiB7XG4gICAgICAgICAgICBpZiAoIWVyciAmJiByZXMuc3RhdHVzQ29kZSA9PSAyMDApIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVzcG9uc2VPYmogPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgICAgICAgICAgICAgIGRvbmUucmVzb2x2ZShyZXNwb25zZU9iaik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzKTtcbiAgICAgICAgICAgICAgICBkb25lLnJlamVjdChlcnIpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBkb25lLnByb21pc2U7XG4gICAgfVxuICAgIHJlcXVlc3RTdHJlYW0obWV0aG9kQXJnLHJvdXRlQXJnLGVuZEFyZzpib29sZWFuID0gdHJ1ZSl7XG4gICAgICAgIGxldCBkb25lID0gcGx1Z2lucy5xLmRlZmVyKCk7XG4gICAgICAgIGlmKG1ldGhvZEFyZyA9PSBcIlBPU1RcIil7XG4gICAgICAgICAgICBsZXQgcmVxdWVzdFN0cmVhbSA9IHBsdWdpbnMucmVxdWVzdC5wb3N0KHRoaXMuc29ja1BhdGggKyByb3V0ZUFyZyk7XG4gICAgICAgICAgICByZXF1ZXN0U3RyZWFtLm9uKFwicmVzcG9uc2VcIiwocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PSAyMDApe1xuICAgICAgICAgICAgICAgICAgICAgICAgcGx1Z2lucy5iZWF1dHlsb2cub2soXCJyZXF1ZXN0IHJldHVybmVkIHN0YXR1cyAyMDAsIHNvIHdlIGFyZSBnb29kIVwiKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBsdWdpbnMuYmVhdXR5bG9nLmVycm9yKFwicmVxdWVzdCByZXR1cm5lZCBlcnJvcjogXCIgKyByZXNwb25zZS5zdGF0dXNDb2RlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUucmVqZWN0KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlcXVlc3RTdHJlYW0ub24oXCJkYXRhXCIsKGRhdGE6QnVmZmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHN0YXR1cyA9IEpTT04ucGFyc2UoZGF0YS50b1N0cmluZygpKS5zdGF0dXM7XG4gICAgICAgICAgICAgICAgcGx1Z2lucy5iZWF1dHlsb2cubG9nKHN0YXR1cyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlcXVlc3RTdHJlYW0ub24oXCJlbmRcIiwoKT0+IHtcbiAgICAgICAgICAgICAgICBkb25lLnJlc29sdmUoKTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkb25lLnByb21pc2U7XG4gICAgfVxufSJdfQ==
