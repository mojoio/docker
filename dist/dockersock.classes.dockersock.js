"use strict";
require("typings-global");
var plugins = require("./dockersock.plugins");
var Dockersock = (function () {
    function Dockersock(pathArg) {
        if (pathArg === void 0) { pathArg = "http://unix:/var/run/docker.sock:"; }
        this.sockPath = pathArg;
    }
    // methods
    Dockersock.prototype.auth = function (userArg, passArg) {
        var done = plugins.q.defer();
        this.request("POST", "");
        return done.promise;
    };
    Dockersock.prototype.listContainers = function () {
        var done = plugins.q.defer();
        this.request("GET", "/containers")
            .then(done.resolve);
        return done.promise;
    };
    ;
    Dockersock.prototype.listContainersDetailed = function () {
        var _this = this;
        var done = plugins.q.defer();
        var detailedDataObject = [];
        this.listContainers()
            .then(function (dataArg) {
            var recursiveCounter = 0;
            var makeDetailed = function () {
                if (typeof dataArg[recursiveCounter] != "undefined") {
                    _this.request("GET", "/containers/" + dataArg[recursiveCounter].Id)
                        .then(function (dataArg2) {
                        detailedDataObject.push(dataArg2);
                        recursiveCounter++;
                        // recursive call
                        makeDetailed();
                    });
                }
                else {
                    done.resolve(detailedDataObject);
                }
            };
            makeDetailed();
        });
        return done.promise;
    };
    ;
    Dockersock.prototype.listContainersRunning = function () {
        var done = plugins.q.defer();
        return done.promise;
    };
    Dockersock.prototype.listContainersStopped = function () {
        var done = plugins.q.defer();
        return done.promise;
    };
    Dockersock.prototype.listImages = function () {
        return this.request("GET", "/images", "?all=true");
    };
    Dockersock.prototype.listImagesDangling = function () {
        return this.request("GET", "/images", "?dangling=true");
    };
    Dockersock.prototype.pullImage = function (imageLabel) {
        return this.requestStream("POST", "/images/create?fromImage=" + imageLabel);
    };
    ;
    Dockersock.prototype.createContainer = function (optionsArg, pullFirstArg) {
        var _this = this;
        if (pullFirstArg === void 0) { pullFirstArg = true; }
        var done = plugins.q.defer();
        var create = function () {
            return _this.request("POST", "/containers/create", "", optionsArg);
        };
        if (pullFirstArg) {
            this.pullImage(optionsArg.Image)
                .then(create)
                .then(done.resolve);
        }
        else {
            create()
                .then(done.resolve);
        }
        return done.promise;
    };
    ;
    Dockersock.prototype.getContainerId = function () {
    };
    ;
    Dockersock.prototype.startContainer = function (containerNameArg) {
        return this.request("POST", "/containers/" + containerNameArg + "/start");
    };
    ;
    Dockersock.prototype.stopContainer = function (containerNameArg) {
        return this.request("POST", "/containers/" + containerNameArg + "/stop");
    };
    ;
    Dockersock.prototype.removeContainer = function (containerNameArg) {
        return this.request("DELETE", "/containers/" + containerNameArg + "?v=1");
    };
    ;
    Dockersock.prototype.clean = function () {
        var done = plugins.q.defer();
        return done.promise;
    };
    ;
    Dockersock.prototype.callOnChange = function (cb) {
        var cbPromise;
        var changeBuffered = false; // when cb is running then buffer any consequent change
        var requestStream = plugins.request.get(this.sockPath + "/events");
        requestStream.on("response", function (response) {
            if (response.statusCode == 200) {
                plugins.beautylog.ok("request returned status 200, so we are good!");
            }
            else {
                plugins.beautylog.error("request returned error: " + response.statusCode);
            }
        });
        requestStream.on("data", function (data) {
            var status = JSON.parse(data.toString()).status;
            plugins.beautylog.logReduced(status);
            if (typeof cbPromise == "undefined" || cbPromise.state == "pending") {
                cbPromise = cb();
            }
            else if (changeBuffered) {
                changeBuffered = true;
                cbPromise.then(function () {
                    changeBuffered = false;
                    cbPromise = cb();
                });
            }
        });
        requestStream.on("end", function () {
        });
    };
    ;
    Dockersock.prototype.request = function (methodArg, routeArg, queryArg, dataArg) {
        if (queryArg === void 0) { queryArg = ""; }
        if (dataArg === void 0) { dataArg = {}; }
        var done = plugins.q.defer();
        var jsonArg = JSON.stringify(dataArg);
        var suffix = "";
        if (methodArg == "GET")
            suffix = "/json";
        var options = {
            method: methodArg,
            url: this.sockPath + routeArg + suffix + queryArg,
            headers: {
                "Content-Type": "application/json"
            },
            body: jsonArg
        };
        plugins.request(options, function (err, res, body) {
            if (!err && res.statusCode == 200) {
                var responseObj = JSON.parse(body);
                done.resolve(responseObj);
            }
            else {
                console.log(err);
                console.log(res);
                done.reject(err);
            }
            ;
        });
        return done.promise;
    };
    Dockersock.prototype.requestStream = function (methodArg, routeArg, endArg) {
        if (endArg === void 0) { endArg = true; }
        var done = plugins.q.defer();
        if (methodArg == "POST") {
            var requestStream = plugins.request.post(this.sockPath + routeArg);
            requestStream.on("response", function (response) {
                if (response.statusCode == 200) {
                    plugins.beautylog.ok("request returned status 200, so we are good!");
                }
                else {
                    plugins.beautylog.error("request returned error: " + response.statusCode);
                    done.reject();
                }
            });
            requestStream.on("data", function (data) {
                var status = JSON.parse(data.toString()).status;
                plugins.beautylog.logReduced(status);
            });
            requestStream.on("end", function () {
                done.resolve();
            });
        }
        return done.promise;
    };
    return Dockersock;
}());
exports.Dockersock = Dockersock;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRvY2tlcnNvY2suY2xhc3Nlcy5kb2NrZXJzb2NrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxRQUFPLGdCQUNQLENBQUMsQ0FEc0I7QUFDdkIsSUFBWSxPQUFPLFdBQU0sc0JBQXNCLENBQUMsQ0FBQTtBQUVoRDtJQUVJLG9CQUFZLE9BQW9EO1FBQXBELHVCQUFvRCxHQUFwRCw2Q0FBb0Q7UUFDNUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7SUFDNUIsQ0FBQztJQUVELFVBQVU7SUFDVix5QkFBSSxHQUFKLFVBQUssT0FBYyxFQUFDLE9BQWM7UUFDOUIsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBQyxFQUFFLENBQUMsQ0FBQztRQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUN4QixDQUFDO0lBQ0QsbUNBQWMsR0FBZDtRQUNJLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUMsYUFBYSxDQUFDO2FBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDeEIsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDeEIsQ0FBQzs7SUFDRCwyQ0FBc0IsR0FBdEI7UUFBQSxpQkFzQkM7UUFyQkcsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM3QixJQUFJLGtCQUFrQixHQUFHLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsY0FBYyxFQUFFO2FBQ2hCLElBQUksQ0FBQyxVQUFDLE9BQU87WUFDVixJQUFJLGdCQUFnQixHQUFHLENBQUMsQ0FBQztZQUN6QixJQUFJLFlBQVksR0FBRztnQkFDZixFQUFFLENBQUEsQ0FBQyxPQUFP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T0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsOENBQThDLENBQUMsQ0FBQztnQkFDekUsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDSixPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQywwQkFBMEIsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7b0JBQzFFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDbEIsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ1AsYUFBYSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUMsVUFBQyxJQUFXO2dCQUNoQyxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQztnQkFDaEQsT0FBTyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDekMsQ0FBQyxDQUFDLENBQUM7WUFDSCxhQUFhLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBQztnQkFDbkIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ25CLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3hCLENBQUM7SUFDTCxpQkFBQztBQUFELENBcEtBLEFBb0tDLElBQUE7QUFwS1ksa0JBQVUsYUFvS3RCLENBQUEiLCJmaWxlIjoiZG9ja2Vyc29jay5jbGFzc2VzLmRvY2tlcnNvY2suanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXCJ0eXBpbmdzLWdsb2JhbFwiXG5pbXBvcnQgKiBhcyBwbHVnaW5zIGZyb20gXCIuL2RvY2tlcnNvY2sucGx1Z2luc1wiO1xuXG5leHBvcnQgY2xhc3MgRG9ja2Vyc29jayB7XG4gICAgc29ja1BhdGg6c3RyaW5nO1xuICAgIGNvbnN0cnVjdG9yKHBhdGhBcmc6c3RyaW5nID0gXCJodHRwOi8vdW5peDovdmFyL3J1bi9kb2NrZXIuc29jazpcIil7XG4gICAgICAgIHRoaXMuc29ja1BhdGggPSBwYXRoQXJnO1xuICAgIH1cblxuICAgIC8vIG1ldGhvZHNcbiAgICBhdXRoKHVzZXJBcmc6c3RyaW5nLHBhc3NBcmc6c3RyaW5nKXtcbiAgICAgICAgbGV0IGRvbmUgPSBwbHVnaW5zLnEuZGVmZXIoKTtcbiAgICAgICAgdGhpcy5yZXF1ZXN0KFwiUE9TVFwiLFwiXCIpO1xuICAgICAgICByZXR1cm4gZG9uZS5wcm9taXNlO1xuICAgIH1cbiAgICBsaXN0Q29udGFpbmVycygpIHtcbiAgICAgICAgbGV0IGRvbmUgPSBwbHVnaW5zLnEuZGVmZXIoKTtcbiAgICAgICAgdGhpcy5yZXF1ZXN0KFwiR0VUXCIsXCIvY29udGFpbmVyc1wiKVxuICAgICAgICAgICAgLnRoZW4oZG9uZS5yZXNvbHZlKTtcbiAgICAgICAgcmV0dXJuIGRvbmUucHJvbWlzZTtcbiAgICB9O1xuICAgIGxpc3RDb250YWluZXJzRGV0YWlsZWQoKSB7XG4gICAgICAgIGxldCBkb25lID0gcGx1Z2lucy5xLmRlZmVyKCk7XG4gICAgICAgIGxldCBkZXRhaWxlZERhdGFPYmplY3QgPSBbXTtcbiAgICAgICAgdGhpcy5saXN0Q29udGFpbmVycygpXG4gICAgICAgICAgICAudGhlbigoZGF0YUFyZykgPT4ge1xuICAgICAgICAgICAgICAgIGxldCByZWN1cnNpdmVDb3VudGVyID0gMDtcbiAgICAgICAgICAgICAgICBsZXQgbWFrZURldGFpbGVkID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YgZGF0YUFyZ1tyZWN1cnNpdmVDb3VudGVyXSAhPSBcInVuZGVmaW5lZFwiKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdChcIkdFVFwiLFwiL2NvbnRhaW5lcnMvXCIgKyBkYXRhQXJnW3JlY3Vyc2l2ZUNvdW50ZXJdLklkKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChkYXRhQXJnMikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWxlZERhdGFPYmplY3QucHVzaChkYXRhQXJnMik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZUNvdW50ZXIrKztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVjdXJzaXZlIGNhbGxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFrZURldGFpbGVkKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb25lLnJlc29sdmUoZGV0YWlsZWREYXRhT2JqZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgbWFrZURldGFpbGVkKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGRvbmUucHJvbWlzZTtcbiAgICB9O1xuICAgIGxpc3RDb250YWluZXJzUnVubmluZygpIHtcbiAgICAgICAgbGV0IGRvbmUgPSBwbHVnaW5zLnEuZGVmZXIoKTtcbiAgICAgICAgcmV0dXJuIGRvbmUucHJvbWlzZTtcbiAgICB9XG4gICAgbGlzdENvbnRhaW5lcnNTdG9wcGVkKCkge1xuICAgICAgICBsZXQgZG9uZSA9IHBsdWdpbnMucS5kZWZlcigpO1xuICAgICAgICByZXR1cm4gZG9uZS5wcm9taXNlO1xuICAgIH1cbiAgICBsaXN0SW1hZ2VzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KFwiR0VUXCIsXCIvaW1hZ2VzXCIsXCI/YWxsPXRydWVcIik7XG4gICAgfVxuICAgIGxpc3RJbWFnZXNEYW5nbGluZygpe1xuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KFwiR0VUXCIsXCIvaW1hZ2VzXCIsXCI/ZGFuZ2xpbmc9dHJ1ZVwiKTtcbiAgICB9XG4gICAgcHVsbEltYWdlKGltYWdlTGFiZWw6c3RyaW5nKXtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdFN0cmVhbShcIlBPU1RcIixcIi9pbWFnZXMvY3JlYXRlP2Zyb21JbWFnZT1cIiArIGltYWdlTGFiZWwpO1xuICAgIH07XG4gICAgY3JlYXRlQ29udGFpbmVyKG9wdGlvbnNBcmcscHVsbEZpcnN0QXJnOmJvb2xlYW4gPSB0cnVlKXtcbiAgICAgICAgbGV0IGRvbmUgPSBwbHVnaW5zLnEuZGVmZXIoKTtcbiAgICAgICAgbGV0IGNyZWF0ZSA9ICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlcXVlc3QoXCJQT1NUXCIsXCIvY29udGFpbmVycy9jcmVhdGVcIixcIlwiLG9wdGlvbnNBcmcpO1xuICAgICAgICB9XG4gICAgICAgIGlmKHB1bGxGaXJzdEFyZyl7XG4gICAgICAgICAgICB0aGlzLnB1bGxJbWFnZShvcHRpb25zQXJnLkltYWdlKVxuICAgICAgICAgICAgICAgIC50aGVuKGNyZWF0ZSlcbiAgICAgICAgICAgICAgICAudGhlbihkb25lLnJlc29sdmUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY3JlYXRlKClcbiAgICAgICAgICAgICAgICAudGhlbihkb25lLnJlc29sdmUpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRvbmUucHJvbWlzZTtcbiAgICB9O1xuICAgIGdldENvbnRhaW5lcklkKCl7XG5cbiAgICB9O1xuICAgIHN0YXJ0Q29udGFpbmVyKGNvbnRhaW5lck5hbWVBcmcpe1xuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KFwiUE9TVFwiLFwiL2NvbnRhaW5lcnMvXCIrIGNvbnRhaW5lck5hbWVBcmcgK1wiL3N0YXJ0XCIpO1xuICAgIH07XG4gICAgc3RvcENvbnRhaW5lcihjb250YWluZXJOYW1lQXJnKXtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVxdWVzdChcIlBPU1RcIixcIi9jb250YWluZXJzL1wiKyBjb250YWluZXJOYW1lQXJnICtcIi9zdG9wXCIpO1xuICAgIH07XG4gICAgcmVtb3ZlQ29udGFpbmVyKGNvbnRhaW5lck5hbWVBcmcpe1xuICAgICAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KFwiREVMRVRFXCIsXCIvY29udGFpbmVycy9cIiArIGNvbnRhaW5lck5hbWVBcmcgKyBcIj92PTFcIik7XG4gICAgfTtcbiAgICBjbGVhbigpIHtcbiAgICAgICAgbGV0IGRvbmUgPSBwbHVnaW5zLnEuZGVmZXIoKTtcbiAgICAgICAgcmV0dXJuIGRvbmUucHJvbWlzZTtcbiAgICB9O1xuICAgIGNhbGxPbkNoYW5nZShjYjpGdW5jdGlvbil7XG4gICAgICAgIGxldCBjYlByb21pc2U7XG4gICAgICAgIGxldCBjaGFuZ2VCdWZmZXJlZDpib29sZWFuID0gZmFsc2U7IC8vIHdoZW4gY2IgaXMgcnVubmluZyB0aGVuIGJ1ZmZlciBhbnkgY29uc2VxdWVudCBjaGFuZ2VcbiAgICAgICAgbGV0IHJlcXVlc3RTdHJlYW0gPSBwbHVnaW5zLnJlcXVlc3QuZ2V0KHRoaXMuc29ja1BhdGggKyBcIi9ldmVudHNcIik7XG4gICAgICAgIHJlcXVlc3RTdHJlYW0ub24oXCJyZXNwb25zZVwiLChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT0gMjAwKXtcbiAgICAgICAgICAgICAgICAgICAgcGx1Z2lucy5iZWF1dHlsb2cub2soXCJyZXF1ZXN0IHJldHVybmVkIHN0YXR1cyAyMDAsIHNvIHdlIGFyZSBnb29kIVwiKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwbHVnaW5zLmJlYXV0eWxvZy5lcnJvcihcInJlcXVlc3QgcmV0dXJuZWQgZXJyb3I6IFwiICsgcmVzcG9uc2Uuc3RhdHVzQ29kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIHJlcXVlc3RTdHJlYW0ub24oXCJkYXRhXCIsKGRhdGE6QnVmZmVyKSA9PiB7XG4gICAgICAgICAgICBsZXQgc3RhdHVzID0gSlNPTi5wYXJzZShkYXRhLnRvU3RyaW5nKCkpLnN0YXR1cztcbiAgICAgICAgICAgIHBsdWdpbnMuYmVhdXR5bG9nLmxvZ1JlZHVjZWQoc3RhdHVzKTtcbiAgICAgICAgICAgIGlmKHR5cGVvZiBjYlByb21pc2UgPT0gXCJ1bmRlZmluZWRcIiB8fCBjYlByb21pc2Uuc3RhdGUgPT0gXCJwZW5kaW5nXCIpe1xuICAgICAgICAgICAgICAgIGNiUHJvbWlzZSA9IGNiKCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNoYW5nZUJ1ZmZlcmVkKSB7XG4gICAgICAgICAgICAgICAgY2hhbmdlQnVmZmVyZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNiUHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY2hhbmdlQnVmZmVyZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgY2JQcm9taXNlID0gY2IoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJlcXVlc3RTdHJlYW0ub24oXCJlbmRcIiwoKT0+IHtcbiAgICAgICAgICAgIFxuICAgICAgICB9KTsgICAgICAgICBcbiAgICB9O1xuICAgIHJlcXVlc3QobWV0aG9kQXJnOnN0cmluZyxyb3V0ZUFyZzpzdHJpbmcscXVlcnlBcmc6c3RyaW5nID0gXCJcIiwgZGF0YUFyZyA9IHt9KXtcbiAgICAgICAgbGV0IGRvbmUgPSBwbHVnaW5zLnEuZGVmZXIoKTtcbiAgICAgICAgbGV0IGpzb25Bcmc6c3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoZGF0YUFyZyk7XG4gICAgICAgIGxldCBzdWZmaXg6c3RyaW5nID0gXCJcIjtcbiAgICAgICAgaWYobWV0aG9kQXJnID09IFwiR0VUXCIpIHN1ZmZpeCA9IFwiL2pzb25cIjtcbiAgICAgICAgbGV0IG9wdGlvbnMgPSB7XG4gICAgICAgICAgICBtZXRob2Q6bWV0aG9kQXJnLFxuICAgICAgICAgICAgdXJsOnRoaXMuc29ja1BhdGggKyByb3V0ZUFyZyArIHN1ZmZpeCArIHF1ZXJ5QXJnLFxuICAgICAgICAgICAgaGVhZGVyczp7XG4gICAgICAgICAgICAgICAgXCJDb250ZW50LVR5cGVcIjpcImFwcGxpY2F0aW9uL2pzb25cIlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJvZHk6anNvbkFyZ1xuICAgICAgICB9O1xuICAgICAgICBwbHVnaW5zLnJlcXVlc3Qob3B0aW9ucywoZXJyLCByZXMsIGJvZHkpID0+IHtcbiAgICAgICAgICAgIGlmICghZXJyICYmIHJlcy5zdGF0dXNDb2RlID09IDIwMCkge1xuICAgICAgICAgICAgICAgIHZhciByZXNwb25zZU9iaiA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgICAgICAgICAgICAgZG9uZS5yZXNvbHZlKHJlc3BvbnNlT2JqKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhyZXMpO1xuICAgICAgICAgICAgICAgIGRvbmUucmVqZWN0KGVycik7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGRvbmUucHJvbWlzZTtcbiAgICB9XG4gICAgcmVxdWVzdFN0cmVhbShtZXRob2RBcmcscm91dGVBcmcsZW5kQXJnOmJvb2xlYW4gPSB0cnVlKXtcbiAgICAgICAgbGV0IGRvbmUgPSBwbHVnaW5zLnEuZGVmZXIoKTtcbiAgICAgICAgaWYobWV0aG9kQXJnID09IFwiUE9TVFwiKXtcbiAgICAgICAgICAgIGxldCByZXF1ZXN0U3RyZWFtID0gcGx1Z2lucy5yZXF1ZXN0LnBvc3QodGhpcy5zb2NrUGF0aCArIHJvdXRlQXJnKTtcbiAgICAgICAgICAgIHJlcXVlc3RTdHJlYW0ub24oXCJyZXNwb25zZVwiLChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZihyZXNwb25zZS5zdGF0dXNDb2RlID09IDIwMCl7XG4gICAgICAgICAgICAgICAgICAgICAgICBwbHVnaW5zLmJlYXV0eWxvZy5vayhcInJlcXVlc3QgcmV0dXJuZWQgc3RhdHVzIDIwMCwgc28gd2UgYXJlIGdvb2QhXCIpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGx1Z2lucy5iZWF1dHlsb2cuZXJyb3IoXCJyZXF1ZXN0IHJldHVybmVkIGVycm9yOiBcIiArIHJlc3BvbnNlLnN0YXR1c0NvZGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZS5yZWplY3QoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmVxdWVzdFN0cmVhbS5vbihcImRhdGFcIiwoZGF0YTpCdWZmZXIpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgc3RhdHVzID0gSlNPTi5wYXJzZShkYXRhLnRvU3RyaW5nKCkpLnN0YXR1cztcbiAgICAgICAgICAgICAgICBwbHVnaW5zLmJlYXV0eWxvZy5sb2dSZWR1Y2VkKHN0YXR1cyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlcXVlc3RTdHJlYW0ub24oXCJlbmRcIiwoKT0+IHtcbiAgICAgICAgICAgICAgICBkb25lLnJlc29sdmUoKTtcbiAgICAgICAgICAgIH0pOyAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkb25lLnByb21pc2U7XG4gICAgfVxufSJdfQ==
